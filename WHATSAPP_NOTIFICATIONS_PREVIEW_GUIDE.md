# WhatsApp Notifications Preview Screen - Admin Guide

## Overview

The WhatsApp Notifications Preview screen is an admin-only module that displays all WhatsApp notification records prepared by the system. This screen is designed for review, testing, and audit purposes during the sandbox phase before production rollout.

## Key Features

### 1. Comprehensive Notification Visibility
- View all WhatsApp notifications generated by the system
- See exactly what messages would be sent to residents
- Track notification history and delivery status

### 2. Sandbox Mode Indicator
- Clear visual indicators that notifications are in sandbox mode
- All notifications show **GUPSHUP_SANDBOX** delivery mode
- Status badge shows **SIMULATED** to confirm no actual delivery

### 3. Advanced Filtering
The screen includes three powerful filters:

#### Status Filter
- **All Statuses**: View all notifications
- **SIMULATED**: Preview-only notifications (not sent)
- **SENT**: Successfully delivered notifications
- **FAILED**: Notifications that encountered errors

#### Trigger Reason Filter
- Filter by what triggered the notification
- Example: "Payment Submitted", "Payment Approved", etc.
- Helps identify notification patterns

#### Date Range Filter
- **All Time**: View complete notification history
- **Today**: Notifications created today
- **Last 7 Days**: Recent week's notifications
- **Last 30 Days**: Current month's notifications

### 4. Summary Statistics Dashboard
Real-time counts displayed at the top:
- Total Notifications
- Simulated Count (blue badge)
- Sent Count (green badge)
- Failed Count (red badge)

### 5. Detailed Message Preview
Each notification row includes a "View Message" button that opens a modal showing:

#### Recipient Information
- Recipient name
- Phone number (formatted)

#### Notification Details
- Trigger reason
- Template name used
- Status badge
- Delivery mode

#### Full Message Content
- Complete WhatsApp message text
- Preserved line breaks for readability
- WhatsApp-style preview (green background bubble)
- Timestamp of creation

## Access Control

### Who Can Access
- **Apartment Admins**: Can view notifications for their apartment only
- **Committee Members**: Same access as apartment admins
- **Super Admins**: Can view all notifications across all apartments

### Who Cannot Access
- **Residents/Occupants**: No access to admin screens
- **Tenants**: No access to admin screens
- **Public Users**: No access without authentication

## Navigation

### For Apartment Admins
1. Log in to the Admin Dashboard
2. Click on **"WhatsApp Notifications"** in the sidebar
3. Located between "AI Classification" and "Help Center"

### For Super Admins
1. Log in to the Super Admin Dashboard
2. Click on **"WhatsApp Notifications"** in the sidebar
3. Located between "Executive Summary" and "Help Center"

## Screen Layout

### Header Section
- Page title: "WhatsApp Notifications (Preview)"
- Description explaining sandbox mode
- Filters toggle button

### Info Banner
Blue informational banner explaining:
- Sandbox mode active
- GUPSHUP_SANDBOX delivery
- No actual messages sent
- Preview and audit purpose only

### Filters Panel (Collapsible)
- Three dropdown filters arranged horizontally
- "Clear All Filters" button at bottom right
- Real-time filtering without page reload

### Statistics Cards
Four summary cards showing:
- Total count (white background)
- Simulated count (blue background)
- Sent count (green background)
- Failed count (red background)

### Notifications Table
Columns displayed:
1. **Created At**: Date and time with calendar icon
2. **Recipient Name**: With user icon
3. **Recipient Phone**: With phone icon, monospace font
4. **Trigger Reason**: Why notification was created
5. **Template**: Template identifier used
6. **Status**: Color-coded badge
7. **Delivery Mode**: Shows GUPSHUP_SANDBOX
8. **Actions**: "View Message" button with eye icon

## Understanding Status Badges

### SIMULATED (Blue Badge)
- Message prepared but not sent
- Sandbox/testing mode
- No actual WhatsApp delivery
- Most common in current phase

### SENT (Green Badge)
- Message successfully delivered to WhatsApp
- Only appears when actual sending is enabled
- Indicates successful delivery confirmation

### FAILED (Red Badge)
- Message attempted but failed
- Could be due to:
  - Invalid phone number
  - Network issues
  - API errors
  - Rate limiting

## Trigger Reasons

### Payment Submitted
- Triggered when owner/tenant submits payment
- Automatically created on "Received" status
- Contains payment amount and society name

### Payment Approved (Future)
- Will trigger when admin approves payment
- Contains approval confirmation details

### Payment Reminder (Future)
- Scheduled reminders for pending payments
- Based on due dates

## Message Preview Modal

### Opening the Modal
- Click "View Message" button in any row
- Modal opens with full notification details
- Background overlay prevents accidental clicks

### Modal Sections

#### 1. Header
- WhatsApp message icon
- "WhatsApp Message Preview" title
- Close button (X icon)

#### 2. Recipient Info Grid
- Left column: Recipient name with icon
- Right column: Phone number with icon

#### 3. Notification Details Grid
Row 1:
- Left: Trigger reason
- Right: Template name

Row 2:
- Left: Status badge
- Right: Delivery mode badge

#### 4. Message Content Box
- Green WhatsApp-style background
- White message bubble inside
- Preserved text formatting
- Line breaks maintained
- Easy to read font

#### 5. Metadata Footer
- Creation timestamp
- Additional context info

#### 6. Action Footer
- "Close" button to dismiss modal

### Closing the Modal
Three ways to close:
1. Click "Close" button in footer
2. Click X button in header
3. Click outside modal on dark overlay

## Data Security

### Data Protection
- All phone numbers are visible only to authorized admins
- Notification content follows privacy guidelines
- No external sharing of notification data
- Audit trail maintained

### RLS (Row Level Security)
- Database-level access control
- Apartment admins see only their notifications
- Super admins have full visibility
- Automatic filtering by apartment_id

## Common Use Cases

### 1. Verify Notification Creation
- Check if payment submissions trigger notifications
- Confirm correct recipient information
- Validate message content accuracy

### 2. Audit Trail Review
- Track all notification events
- Identify patterns and trends
- Support compliance requirements

### 3. Testing Message Templates
- Preview actual message text
- Verify formatting and line breaks
- Check variable substitution (name, amount, society)

### 4. Troubleshoot Issues
- Filter by FAILED status
- Identify problematic phone numbers
- Review error patterns

### 5. Pre-Production Validation
- Confirm system is creating notifications correctly
- Review message quality before going live
- Build confidence in the notification system

## Best Practices

### Regular Review
- Check notifications daily during testing phase
- Verify all triggered events are captured
- Ensure message quality meets standards

### Filter Usage
- Use date filters to focus on recent activity
- Apply status filters when troubleshooting
- Combine filters for specific investigations

### Message Quality Checks
- Review message previews for clarity
- Verify recipient names are correct
- Check amount formatting
- Confirm society names are accurate

### Documentation
- Keep track of notification patterns
- Document any issues discovered
- Share feedback with development team

## Technical Details

### Database Table
- Table name: `notification_outbox`
- Columns include: id, payment_submission_id, recipient_name, recipient_phone, channel, delivery_mode, template_name, message_preview, trigger_reason, status, created_at

### Automatic Creation
- Triggered by database trigger on payment_submissions table
- Non-blocking design (never blocks payment submission)
- Error handling prevents system failures

### Real-Time Updates
- Page loads latest notifications on mount
- Manual refresh by navigating away and back
- Filters apply instantly without backend calls

## Roadmap

### Future Enhancements

#### Phase 2: Production Delivery
- Enable actual WhatsApp message sending
- Update status from SIMULATED to SENT
- Add delivery confirmation tracking

#### Phase 3: Advanced Features
- Retry failed notifications
- Schedule notification timing
- Custom message templates
- Bulk notification operations

#### Phase 4: Analytics
- Notification delivery rate metrics
- Response time tracking
- User engagement statistics
- Template performance analysis

## Support and Contact

### For Technical Issues
- Check browser console for errors
- Verify authentication and permissions
- Review database RLS policies
- Contact system administrator

### For Feature Requests
- Document specific use cases
- Provide examples of desired functionality
- Share with product team
- Include priority and business justification

## FAQ

### Q: Why aren't messages being sent?
A: The system is in GUPSHUP_SANDBOX mode for testing. No actual messages are sent to users until production deployment.

### Q: Can I delete notification records?
A: No, this screen is read-only. Notification records serve as an audit trail and should not be deleted.

### Q: Why don't I see all notifications?
A: Apartment admins only see notifications for their apartment. Super admins see all notifications.

### Q: Can residents see this screen?
A: No, this screen is admin-only. Residents cannot access admin dashboard features.

### Q: How long are notifications stored?
A: Currently, all notifications are stored indefinitely for audit purposes. A retention policy may be implemented in the future.

### Q: Can I resend a notification?
A: Not currently. This is a view-only screen. Resend functionality may be added in future phases.

### Q: What happens if a phone number is invalid?
A: The notification is still created with SIMULATED status. In production, invalid numbers would result in FAILED status.

### Q: How do I know if the system is working correctly?
A: Check that notifications are created whenever payments are submitted. Verify message content is accurate and recipient details are correct.

## Conclusion

The WhatsApp Notifications Preview screen is a powerful tool for reviewing and validating the notification system before production deployment. Use it regularly to ensure message quality, verify system behavior, and build confidence in the automated notification infrastructure.

For questions or issues, contact your system administrator or refer to the technical documentation.
